{"version":3,"file":"build.js","names":["_arktype","require","_fsExtra","_interopRequireDefault","_kleur","_path","_schema","_loadConfig","logger","_interopRequireWildcard","_workerize","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","args","exports","target","type","description","choices","build","argv","root","process","cwd","projectPackagePath","path","resolve","fs","pathExists","Error","result","loadConfig","config","$0","parsed","errors","filepath","summary","source","output","targets","exclude","commonjs","some","Array","isArray","module","variants","buildTarget","Promise","all","map","options","undefined","find","report","grouped","run","esm","name","kleur","blue"],"sources":["../src/build.ts"],"sourcesContent":["import { type } from 'arktype';\nimport fs from 'fs-extra';\nimport kleur from 'kleur';\nimport path from 'path';\nimport yargs from 'yargs';\nimport { config, type Config, type Target, type TargetOptions } from './schema';\nimport { loadConfig } from './utils/loadConfig';\nimport * as logger from './utils/logger';\nimport { run } from './utils/workerize';\n\nexport const args = {\n  target: {\n    type: 'string',\n    description: 'The target to build',\n    choices: ['commonjs', 'module', 'typescript', 'codegen'] satisfies Target[],\n  },\n} satisfies Record<'target', yargs.Options>;\n\ntype Argv = {\n  $0: string;\n  target?: Target;\n};\n\nexport async function build(argv: Argv) {\n  const root = process.cwd();\n\n  const projectPackagePath = path.resolve(root, 'package.json');\n\n  if (!(await fs.pathExists(projectPackagePath))) {\n    throw new Error(\n      `Couldn't find a 'package.json' file in '${root}'. Are you in a project folder?`\n    );\n  }\n\n  const result = loadConfig(root);\n\n  if (!result?.config) {\n    throw new Error(\n      `No configuration found. Run '${argv.$0} init' to create one automatically.`\n    );\n  }\n\n  const parsed = config(result.config);\n\n  if (parsed instanceof type.errors) {\n    throw new Error(\n      `Invalid configuration in ${result.filepath}: ${parsed.summary}`\n    );\n  }\n\n  const { source, output, targets, exclude } = parsed;\n\n  const commonjs = targets.some((t) =>\n    Array.isArray(t) ? t[0] === 'commonjs' : t === 'commonjs'\n  );\n\n  const module = targets.some((t) =>\n    Array.isArray(t) ? t[0] === 'module' : t === 'module'\n  );\n\n  const variants = {\n    commonjs,\n    module,\n  };\n\n  if (argv.target != null) {\n    await buildTarget({\n      root,\n      target: argv.target,\n      source,\n      output,\n      exclude,\n      config: parsed,\n      variants,\n    });\n  } else {\n    await Promise.all(\n      targets.map(async (target) =>\n        buildTarget({\n          root,\n          target: Array.isArray(target) ? target[0] : target,\n          source,\n          output,\n          exclude,\n          config: parsed,\n          variants,\n        })\n      )\n    );\n  }\n}\n\nasync function buildTarget({\n  root,\n  target,\n  source,\n  output,\n  exclude,\n  config,\n  variants,\n}: {\n  root: string;\n  target: Target;\n  source: string;\n  output: string;\n  exclude: string;\n  config: Config;\n  variants: {\n    commonjs?: boolean;\n    module?: boolean;\n  };\n}) {\n  const options = config.targets\n    .map((t) => (Array.isArray(t) ? t : ([t, undefined] as const)))\n    .find((t) => t[0] === target)?.[1];\n\n  const report = logger.grouped(target);\n\n  switch (target) {\n    case 'commonjs':\n    case 'module':\n      await run(target, {\n        root,\n        source: path.resolve(root, source),\n        output: path.resolve(root, output, target),\n        exclude,\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-type-assertion\n        options: options as TargetOptions<'commonjs' | 'module'>,\n        variants,\n        report,\n      });\n      break;\n    case 'typescript':\n      {\n        const esm =\n          config.targets?.some((t) => {\n            if (Array.isArray(t)) {\n              const [name, options] = t;\n\n              if (name === 'module') {\n                return options && 'esm' in options && options?.esm;\n              }\n            }\n\n            return false;\n          }) ?? false;\n\n        await run('typescript', {\n          root,\n          source: path.resolve(root, source),\n          output: path.resolve(root, output, 'typescript'),\n          // eslint-disable-next-line @typescript-eslint/no-unsafe-type-assertion\n          options: options as TargetOptions<'typescript'>,\n          esm,\n          variants,\n          report,\n        });\n      }\n      break;\n    case 'codegen':\n      await run('codegen', {\n        root,\n        source: path.resolve(root, source),\n        report,\n      });\n      break;\n    case 'custom':\n      await run('custom', {\n        root,\n        source: path.resolve(root, source),\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-type-assertion\n        options: options as TargetOptions<'custom'>,\n        report,\n      });\n      break;\n    default:\n      throw new Error(`Invalid target ${kleur.blue(target)}.`);\n  }\n}\n"],"mappings":";;;;;;;AAAA,IAAAA,QAAA,GAAAC,OAAA;AACA,IAAAC,QAAA,GAAAC,sBAAA,CAAAF,OAAA;AACA,IAAAG,MAAA,GAAAD,sBAAA,CAAAF,OAAA;AACA,IAAAI,KAAA,GAAAF,sBAAA,CAAAF,OAAA;AAEA,IAAAK,OAAA,GAAAL,OAAA;AACA,IAAAM,WAAA,GAAAN,OAAA;AACA,IAAAO,MAAA,GAAAC,uBAAA,CAAAR,OAAA;AACA,IAAAS,UAAA,GAAAT,OAAA;AAAwC,SAAAU,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAH,wBAAAG,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA,SAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAAA,SAAAjB,uBAAAS,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAI,UAAA,GAAAJ,CAAA,KAAAK,OAAA,EAAAL,CAAA;AAEjC,MAAMmB,IAAI,GAAAC,OAAA,CAAAD,IAAA,GAAG;EAClBE,MAAM,EAAE;IACNC,IAAI,EAAE,QAAQ;IACdC,WAAW,EAAE,qBAAqB;IAClCC,OAAO,EAAE,CAAC,UAAU,EAAE,QAAQ,EAAE,YAAY,EAAE,SAAS;EACzD;AACF,CAA2C;AAOpC,eAAeC,KAAKA,CAACC,IAAU,EAAE;EACtC,MAAMC,IAAI,GAAGC,OAAO,CAACC,GAAG,CAAC,CAAC;EAE1B,MAAMC,kBAAkB,GAAGC,aAAI,CAACC,OAAO,CAACL,IAAI,EAAE,cAAc,CAAC;EAE7D,IAAI,EAAE,MAAMM,gBAAE,CAACC,UAAU,CAACJ,kBAAkB,CAAC,CAAC,EAAE;IAC9C,MAAM,IAAIK,KAAK,CACb,2CAA2CR,IAAI,iCACjD,CAAC;EACH;EAEA,MAAMS,MAAM,GAAG,IAAAC,sBAAU,EAACV,IAAI,CAAC;EAE/B,IAAI,CAACS,MAAM,EAAEE,MAAM,EAAE;IACnB,MAAM,IAAIH,KAAK,CACb,gCAAgCT,IAAI,CAACa,EAAE,qCACzC,CAAC;EACH;EAEA,MAAMC,MAAM,GAAG,IAAAF,cAAM,EAACF,MAAM,CAACE,MAAM,CAAC;EAEpC,IAAIE,MAAM,YAAYlB,aAAI,CAACmB,MAAM,EAAE;IACjC,MAAM,IAAIN,KAAK,CACb,4BAA4BC,MAAM,CAACM,QAAQ,KAAKF,MAAM,CAACG,OAAO,EAChE,CAAC;EACH;EAEA,MAAM;IAAEC,MAAM;IAAEC,MAAM;IAAEC,OAAO;IAAEC;EAAQ,CAAC,GAAGP,MAAM;EAEnD,MAAMQ,QAAQ,GAAGF,OAAO,CAACG,IAAI,CAAE9C,CAAC,IAC9B+C,KAAK,CAACC,OAAO,CAAChD,CAAC,CAAC,GAAGA,CAAC,CAAC,CAAC,CAAC,KAAK,UAAU,GAAGA,CAAC,KAAK,UACjD,CAAC;EAED,MAAMiD,MAAM,GAAGN,OAAO,CAACG,IAAI,CAAE9C,CAAC,IAC5B+C,KAAK,CAACC,OAAO,CAAChD,CAAC,CAAC,GAAGA,CAAC,CAAC,CAAC,CAAC,KAAK,QAAQ,GAAGA,CAAC,KAAK,QAC/C,CAAC;EAED,MAAMkD,QAAQ,GAAG;IACfL,QAAQ;IACRI;EACF,CAAC;EAED,IAAI1B,IAAI,CAACL,MAAM,IAAI,IAAI,EAAE;IACvB,MAAMiC,WAAW,CAAC;MAChB3B,IAAI;MACJN,MAAM,EAAEK,IAAI,CAACL,MAAM;MACnBuB,MAAM;MACNC,MAAM;MACNE,OAAO;MACPT,MAAM,EAAEE,MAAM;MACda;IACF,CAAC,CAAC;EACJ,CAAC,MAAM;IACL,MAAME,OAAO,CAACC,GAAG,CACfV,OAAO,CAACW,GAAG,CAAC,MAAOpC,MAAM,IACvBiC,WAAW,CAAC;MACV3B,IAAI;MACJN,MAAM,EAAE6B,KAAK,CAACC,OAAO,CAAC9B,MAAM,CAAC,GAAGA,MAAM,CAAC,CAAC,CAAC,GAAGA,MAAM;MAClDuB,MAAM;MACNC,MAAM;MACNE,OAAO;MACPT,MAAM,EAAEE,MAAM;MACda;IACF,CAAC,CACH,CACF,CAAC;EACH;AACF;AAEA,eAAeC,WAAWA,CAAC;EACzB3B,IAAI;EACJN,MAAM;EACNuB,MAAM;EACNC,MAAM;EACNE,OAAO;EACPT,MAAM;EACNe;AAYF,CAAC,EAAE;EACD,MAAMK,OAAO,GAAGpB,MAAM,CAACQ,OAAO,CAC3BW,GAAG,CAAEtD,CAAC,IAAM+C,KAAK,CAACC,OAAO,CAAChD,CAAC,CAAC,GAAGA,CAAC,GAAI,CAACA,CAAC,EAAEwD,SAAS,CAAY,CAAC,CAC9DC,IAAI,CAAEzD,CAAC,IAAKA,CAAC,CAAC,CAAC,CAAC,KAAKkB,MAAM,CAAC,GAAG,CAAC,CAAC;EAEpC,MAAMwC,MAAM,GAAGjE,MAAM,CAACkE,OAAO,CAACzC,MAAM,CAAC;EAErC,QAAQA,MAAM;IACZ,KAAK,UAAU;IACf,KAAK,QAAQ;MACX,MAAM,IAAA0C,cAAG,EAAC1C,MAAM,EAAE;QAChBM,IAAI;QACJiB,MAAM,EAAEb,aAAI,CAACC,OAAO,CAACL,IAAI,EAAEiB,MAAM,CAAC;QAClCC,MAAM,EAAEd,aAAI,CAACC,OAAO,CAACL,IAAI,EAAEkB,MAAM,EAAExB,MAAM,CAAC;QAC1C0B,OAAO;QACP;QACAW,OAAO,EAAEA,OAA+C;QACxDL,QAAQ;QACRQ;MACF,CAAC,CAAC;MACF;IACF,KAAK,YAAY;MACf;QACE,MAAMG,GAAG,GACP1B,MAAM,CAACQ,OAAO,EAAEG,IAAI,CAAE9C,CAAC,IAAK;UAC1B,IAAI+C,KAAK,CAACC,OAAO,CAAChD,CAAC,CAAC,EAAE;YACpB,MAAM,CAAC8D,IAAI,EAAEP,OAAO,CAAC,GAAGvD,CAAC;YAEzB,IAAI8D,IAAI,KAAK,QAAQ,EAAE;cACrB,OAAOP,OAAO,IAAI,KAAK,IAAIA,OAAO,IAAIA,OAAO,EAAEM,GAAG;YACpD;UACF;UAEA,OAAO,KAAK;QACd,CAAC,CAAC,IAAI,KAAK;QAEb,MAAM,IAAAD,cAAG,EAAC,YAAY,EAAE;UACtBpC,IAAI;UACJiB,MAAM,EAAEb,aAAI,CAACC,OAAO,CAACL,IAAI,EAAEiB,MAAM,CAAC;UAClCC,MAAM,EAAEd,aAAI,CAACC,OAAO,CAACL,IAAI,EAAEkB,MAAM,EAAE,YAAY,CAAC;UAChD;UACAa,OAAO,EAAEA,OAAsC;UAC/CM,GAAG;UACHX,QAAQ;UACRQ;QACF,CAAC,CAAC;MACJ;MACA;IACF,KAAK,SAAS;MACZ,MAAM,IAAAE,cAAG,EAAC,SAAS,EAAE;QACnBpC,IAAI;QACJiB,MAAM,EAAEb,aAAI,CAACC,OAAO,CAACL,IAAI,EAAEiB,MAAM,CAAC;QAClCiB;MACF,CAAC,CAAC;MACF;IACF,KAAK,QAAQ;MACX,MAAM,IAAAE,cAAG,EAAC,QAAQ,EAAE;QAClBpC,IAAI;QACJiB,MAAM,EAAEb,aAAI,CAACC,OAAO,CAACL,IAAI,EAAEiB,MAAM,CAAC;QAClC;QACAc,OAAO,EAAEA,OAAkC;QAC3CG;MACF,CAAC,CAAC;MACF;IACF;MACE,MAAM,IAAI1B,KAAK,CAAC,kBAAkB+B,cAAK,CAACC,IAAI,CAAC9C,MAAM,CAAC,GAAG,CAAC;EAC5D;AACF","ignoreList":[]}
{"version":3,"file":"init.test.js","names":["_vitest","require","_fsExtra","_mockFs","_interopRequireDefault","_mockStdin","_nodePath","_init","e","__esModule","default","vi","mock","name","version","io","root","enter","waitFor","callback","interval","timeout","Promise","resolve","reject","intervalId","setInterval","clearInterval","undefined","error","beforeEach","stdin","mockFs","JSON","stringify","afterEach","restore","restoreAllMocks","test","writeMock","spyOn","process","stdout","mockImplementation","chdir","run","lastCall","Error","String","send","expect","toHaveBeenLastCalledWith","stringMatching","all","init","readFile","join","toMatchSnapshot"],"sources":["../../src/__tests__/init.test.ts"],"sourcesContent":["import { afterEach, beforeEach, expect, test, vi } from 'vitest';\nimport { readFile } from 'fs-extra';\nimport mockFs from 'mock-fs';\nimport { stdin } from 'mock-stdin';\nimport { join } from 'node:path';\nimport { init } from '../init';\n\nvi.mock('../../package.json', () => ({\n  default: {\n    name: 'react-native-builder-bob',\n    version: '0.5.0',\n  },\n}));\n\nlet io: ReturnType<typeof stdin> | undefined;\n\nconst root = '/path/to/library';\n\nconst enter = '\\x0D';\n\nconst waitFor = async (callback: () => void) => {\n  const interval = 10;\n\n  let timeout = 50;\n\n  return new Promise((resolve, reject) => {\n    const intervalId = setInterval(() => {\n      try {\n        callback();\n        clearInterval(intervalId);\n        resolve(undefined);\n      } catch (error) {\n        if (timeout <= 0) {\n          clearInterval(intervalId);\n          // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n          reject(error);\n        }\n\n        timeout -= interval;\n      }\n    }, interval);\n  });\n};\n\nbeforeEach(() => {\n  io = stdin();\n\n  mockFs({\n    [root]: {\n      'package.json': JSON.stringify({\n        name: 'library',\n        version: '1.0.0',\n      }),\n      'src': {\n        'index.ts': \"export default 'hello world';\",\n      },\n    },\n  });\n});\n\nafterEach(() => {\n  io?.restore();\n  mockFs.restore();\n  vi.restoreAllMocks();\n});\n\ntest('initializes the configuration', async () => {\n  const writeMock = vi\n    .spyOn(process.stdout, 'write')\n    .mockImplementation(() => true);\n\n  process.chdir(root);\n\n  const run = async () => {\n    await waitFor(() => {\n      const lastCall = writeMock.mock.lastCall;\n\n      if (lastCall == null) {\n        throw new Error('No output');\n      }\n\n      if (/The working directory is not clean/.test(String(lastCall[0]))) {\n        io?.send('y');\n      }\n    });\n\n    await waitFor(() => {\n      expect(writeMock).toHaveBeenLastCalledWith(\n        expect.stringMatching('Where are your source files?')\n      );\n    });\n\n    io?.send(enter);\n\n    await waitFor(() => {\n      expect(writeMock).toHaveBeenLastCalledWith(\n        expect.stringMatching('Where do you want to generate the output files?')\n      );\n    });\n\n    io?.send(enter);\n\n    await waitFor(() => {\n      expect(writeMock).toHaveBeenLastCalledWith(\n        expect.stringMatching('Which targets do you want to build?')\n      );\n    });\n\n    io?.send(enter);\n\n    await waitFor(() => {\n      expect(writeMock).toHaveBeenLastCalledWith(\n        expect.stringMatching(\n          \"You have enabled 'typescript' compilation, but we couldn't find a 'tsconfig.json' in project root\"\n        )\n      );\n    });\n\n    io?.send(enter);\n  };\n\n  await Promise.all([run(), init()]);\n\n  expect(writeMock).toHaveBeenLastCalledWith(\n    expect.stringMatching('configured successfully!')\n  );\n\n  expect(await readFile(join(root, 'package.json'), 'utf8')).toMatchSnapshot();\n\n  expect(await readFile(join(root, 'tsconfig.json'), 'utf8')).toMatchSnapshot();\n});\n"],"mappings":";;AAAA,IAAAA,OAAA,GAAAC,OAAA;AACA,IAAAC,QAAA,GAAAD,OAAA;AACA,IAAAE,OAAA,GAAAC,sBAAA,CAAAH,OAAA;AACA,IAAAI,UAAA,GAAAJ,OAAA;AACA,IAAAK,SAAA,GAAAL,OAAA;AACA,IAAAM,KAAA,GAAAN,OAAA;AAA+B,SAAAG,uBAAAI,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAE/BG,UAAE,CAACC,IAAI,CAAC,oBAAoB,EAAE,OAAO;EACnCF,OAAO,EAAE;IACPG,IAAI,EAAE,0BAA0B;IAChCC,OAAO,EAAE;EACX;AACF,CAAC,CAAC,CAAC;AAEH,IAAIC,EAAwC;AAE5C,MAAMC,IAAI,GAAG,kBAAkB;AAE/B,MAAMC,KAAK,GAAG,MAAM;AAEpB,MAAMC,OAAO,GAAG,MAAOC,QAAoB,IAAK;EAC9C,MAAMC,QAAQ,GAAG,EAAE;EAEnB,IAAIC,OAAO,GAAG,EAAE;EAEhB,OAAO,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;IACtC,MAAMC,UAAU,GAAGC,WAAW,CAAC,MAAM;MACnC,IAAI;QACFP,QAAQ,CAAC,CAAC;QACVQ,aAAa,CAACF,UAAU,CAAC;QACzBF,OAAO,CAACK,SAAS,CAAC;MACpB,CAAC,CAAC,OAAOC,KAAK,EAAE;QACd,IAAIR,OAAO,IAAI,CAAC,EAAE;UAChBM,aAAa,CAACF,UAAU,CAAC;UACzB;UACAD,MAAM,CAACK,KAAK,CAAC;QACf;QAEAR,OAAO,IAAID,QAAQ;MACrB;IACF,CAAC,EAAEA,QAAQ,CAAC;EACd,CAAC,CAAC;AACJ,CAAC;AAED,IAAAU,kBAAU,EAAC,MAAM;EACff,EAAE,GAAG,IAAAgB,gBAAK,EAAC,CAAC;EAEZ,IAAAC,eAAM,EAAC;IACL,CAAChB,IAAI,GAAG;MACN,cAAc,EAAEiB,IAAI,CAACC,SAAS,CAAC;QAC7BrB,IAAI,EAAE,SAAS;QACfC,OAAO,EAAE;MACX,CAAC,CAAC;MACF,KAAK,EAAE;QACL,UAAU,EAAE;MACd;IACF;EACF,CAAC,CAAC;AACJ,CAAC,CAAC;AAEF,IAAAqB,iBAAS,EAAC,MAAM;EACdpB,EAAE,EAAEqB,OAAO,CAAC,CAAC;EACbJ,eAAM,CAACI,OAAO,CAAC,CAAC;EAChBzB,UAAE,CAAC0B,eAAe,CAAC,CAAC;AACtB,CAAC,CAAC;AAEF,IAAAC,YAAI,EAAC,+BAA+B,EAAE,YAAY;EAChD,MAAMC,SAAS,GAAG5B,UAAE,CACjB6B,KAAK,CAACC,OAAO,CAACC,MAAM,EAAE,OAAO,CAAC,CAC9BC,kBAAkB,CAAC,MAAM,IAAI,CAAC;EAEjCF,OAAO,CAACG,KAAK,CAAC5B,IAAI,CAAC;EAEnB,MAAM6B,GAAG,GAAG,MAAAA,CAAA,KAAY;IACtB,MAAM3B,OAAO,CAAC,MAAM;MAClB,MAAM4B,QAAQ,GAAGP,SAAS,CAAC3B,IAAI,CAACkC,QAAQ;MAExC,IAAIA,QAAQ,IAAI,IAAI,EAAE;QACpB,MAAM,IAAIC,KAAK,CAAC,WAAW,CAAC;MAC9B;MAEA,IAAI,oCAAoC,CAACT,IAAI,CAACU,MAAM,CAACF,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE;QAClE/B,EAAE,EAAEkC,IAAI,CAAC,GAAG,CAAC;MACf;IACF,CAAC,CAAC;IAEF,MAAM/B,OAAO,CAAC,MAAM;MAClB,IAAAgC,cAAM,EAACX,SAAS,CAAC,CAACY,wBAAwB,CACxCD,cAAM,CAACE,cAAc,CAAC,8BAA8B,CACtD,CAAC;IACH,CAAC,CAAC;IAEFrC,EAAE,EAAEkC,IAAI,CAAChC,KAAK,CAAC;IAEf,MAAMC,OAAO,CAAC,MAAM;MAClB,IAAAgC,cAAM,EAACX,SAAS,CAAC,CAACY,wBAAwB,CACxCD,cAAM,CAACE,cAAc,CAAC,iDAAiD,CACzE,CAAC;IACH,CAAC,CAAC;IAEFrC,EAAE,EAAEkC,IAAI,CAAChC,KAAK,CAAC;IAEf,MAAMC,OAAO,CAAC,MAAM;MAClB,IAAAgC,cAAM,EAACX,SAAS,CAAC,CAACY,wBAAwB,CACxCD,cAAM,CAACE,cAAc,CAAC,qCAAqC,CAC7D,CAAC;IACH,CAAC,CAAC;IAEFrC,EAAE,EAAEkC,IAAI,CAAChC,KAAK,CAAC;IAEf,MAAMC,OAAO,CAAC,MAAM;MAClB,IAAAgC,cAAM,EAACX,SAAS,CAAC,CAACY,wBAAwB,CACxCD,cAAM,CAACE,cAAc,CACnB,mGACF,CACF,CAAC;IACH,CAAC,CAAC;IAEFrC,EAAE,EAAEkC,IAAI,CAAChC,KAAK,CAAC;EACjB,CAAC;EAED,MAAMK,OAAO,CAAC+B,GAAG,CAAC,CAACR,GAAG,CAAC,CAAC,EAAE,IAAAS,UAAI,EAAC,CAAC,CAAC,CAAC;EAElC,IAAAJ,cAAM,EAACX,SAAS,CAAC,CAACY,wBAAwB,CACxCD,cAAM,CAACE,cAAc,CAAC,0BAA0B,CAClD,CAAC;EAED,IAAAF,cAAM,EAAC,MAAM,IAAAK,iBAAQ,EAAC,IAAAC,cAAI,EAACxC,IAAI,EAAE,cAAc,CAAC,EAAE,MAAM,CAAC,CAAC,CAACyC,eAAe,CAAC,CAAC;EAE5E,IAAAP,cAAM,EAAC,MAAM,IAAAK,iBAAQ,EAAC,IAAAC,cAAI,EAACxC,IAAI,EAAE,eAAe,CAAC,EAAE,MAAM,CAAC,CAAC,CAACyC,eAAe,CAAC,CAAC;AAC/E,CAAC,CAAC","ignoreList":[]}